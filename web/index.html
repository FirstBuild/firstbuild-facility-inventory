
<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hackathon | Inventory Management</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      var firebase = new Firebase('https://firstbuild-sandbox.firebaseio.com');

      var keybuf = "";
      var current_transaction = {};

      $(document).bind("keyup",function(e){
        
        if (e.keyCode==13)
        {

          if (keybuf=="STARTPURCHASE")
          {
            start_transaction("purchase");
          }
          else if (keybuf=="STARTREORDER")
          {
            start_transaction("reorder");
          }
          else if (keybuf=="END")
          {
            end_transaction();
          }
          else
          {
            try {
              add_item_to_transaction(keybuf);
            } catch (e)
            {
              console.log ("error");
            }
          }
          keybuf = "";
        }
        else
        {
          keybuf = keybuf + String.fromCharCode(e.keyCode);
        }
        
      });

      function start_transaction(type)
      {
        current_transaction.type = type;
        console.log("start transaction: " + type);
      }

      function end_transaction()
      {
        current_transaction.type = type;
        console.log("end transaction");
      }

      function add_item_to_transaction(item)
      {
        console.log("item requested to be added: " + item);
        firebase.child('inventory').child(item).once('value', function(snapshot) {
          var content = snapshot.val() ;
          if (content)
          {
            document.getElementById("successwav").play();
            current_transaction.item = content;
            current_transaction.item.key = snapshot.key();
            firebase.child('pending_transactions').push(current_transaction);
            //firebase.child('users').child(user).update(content, callback);
            console.log("item added: ");
            console.log(content);
          }
          else
          {
            document.getElementById("failwav").play();
          }
          
        });  
      }

      // function checkout(user, item, callback) {
      //   firebase.child('users').child(user).once('value', function(snapshot) {
      //     var content = snapshot.val() || {
      //       items: []
      //     };

      //     content.items.push(item);
      //     firebase.child('users').child(user).update(content, callback);
      //   });
      // }

      // function checkin(user, item, callback) {
      //   firebase.child('users').child(user).once('value', function(snapshot) {
      //     var content = snapshot.val() || {
      //       items: []
      //     };

      //     for (var i = 0; i < content.items.length; i++) {
      //       if (content.items[i].toLowerCase() == item.toLowerCase()) {
      //         content.items.splice(i, 1);
      //         break;
      //       }
      //     }

      //     firebase.child('users').child(user).update(content, callback);
      //   });
      // }

      // function get_input() {
      //   var badge = $('#scanned_badge').val();
      //   var item = $('#scanned_item').val();

      //   if (badge && item) {
      //     return { badge: badge, item: item };
      //   }
      // }

      // function reset_input() {
      //   $('#scanned_item').val('');
      // }

      // function checkin_click() {
      //   var input = get_input();

      //   if (input) {
      //     checkin(input.badge, input.item);
      //     reset_input();
      //   }
      //   else {
      //     alert('Please scan a badge and an item');
      //   }
      // }

      // function checkout_click() {
      //   var input = get_input();

      //   if (input) {
      //     checkout(input.badge, input.item);
      //     reset_input();
      //   }
      //   else {
      //     alert('Please scan a badge and an item');
      //   }
      // }

      function flatten(content) {
        var items = [];
        // if (content) {
        //   for (var transaction in content) {
        //     items.push(transaction);
        //   }
        // }
        items.push(content);
        return items;
      }

      function mapFunction(item)
      {
        console.log(item);
        return '<tr>'
              + '<td>' + "a" +'</td>'
              + '<td>' + "b" + '</td>'
              + '<td>' + item.url + '</td>'
              + '<td>' + item.retailprice + '</td>'
              + '</tr>';
      }

      function view(snapshot) {
        $('#pending_transactions').html(
          flatten(snapshot.val()).map(mapFunction));
      }

      // function view(snapshot) {
      //   console.log(snapshot.item)
      //   content = snapshot.val();
      //   $('#pending_transactions').html(
      //     '<tr>'
      //         + '<td>' + content.type + '</td>'
      //         + '<td>' + content.item.key + '</td>'
      //         + '<td>' + content.item.url + '</td>'
      //         + '<td>' + content.item.retailprice + '</td>'
      //         + '</tr>').join('');
      //     // flatten(snapshot.val())
      //     // .map(function(item) {
      //     //   return '<tr>'
      //     //     + '<td>' + item.user + '</td>'
      //     //     + '<td>' + item.items.join(', ') + '</td>'
      //     //     + '</tr>';
      //     // })
      //     // .join(''));
      // }
    </script>
  </head>
  <body>
    <audio src="success.wav" id="successwav" autostart="false"></audio>
    <audio src="fail.wav" id="failwav" autostart="false"></audio>
    <h3>&nbsp; Radio Shed</h3>
   <!-- <form>
      <div class="row collapse">
        <div class="small-3 large-2 columns">
          <span class="prefix">Badge</span>
        </div>
        <div class="small-9 large-10 columns">
          <input type="text" id="scanned_badge" placeholder="Scan badge...">
        </div>
      </div>
      <div class="row collapse">
        <div class="small-3 large-2 columns">
          <span class="prefix">Item</span>
        </div>
        <div class="small-9 large-10 columns">
          <input type="text" id="scanned_item" placeholder="Scan item...">
        </div>
      </div>
      <div class="row collapse">
        <div class="small-4 large-4 columns">
          <a href="javascript:checkout_click()" class="button expand">Check Out</a>
        </div>
        <div class="small-4 large-4 columns">
          <div></div>
        </div>
        <div class="small-4 large-4 columns">
          <a href="javascript:checkin_click()" class="button expand success">Check In</a>
        </div>
      </div>
    </form>
  -->
    <h4>&nbsp; Pending Items</h4>
    <table>
      <thead>
        <tr>
          <th width="200">Type</th>
          <th>Item</th>
          <th>URL</th>
          <th>Retail Price</th>
        </tr>
      </thead>
      <tbody id="pending_transactions">
      </tbody>
    </table>
    
   
    <script>
      $(document).foundation();

      $(document).ready(function() {
        firebase.child('pending_transactions').on('value', view);
      });
    </script>
  </body>
</html>
