
<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hackathon | Inventory Management</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      var firebase = new Firebase('https://firstbuild-hackathon.firebaseio.com');

      var keybuf = "";

      // $(document).keydown(function(e){
      //   console.log(e);
      // });

      $(document).bind("keyup",function(e){
        
        console.log(e);

        if (e.keyCode==13)
        {

          if (keybuf=="STARTPURCHASE")
          {
            start_transaction();
          }
          else if (keybuf=="STARTREORDER")
          {
            start_transaction();
          }
          else if (keybuf=="END")
          {
            end_transaction();
          }
          else
          {
            add_item_to_transaction(keybuf);
          }
          keybuf = "";
        }
        else
        {
          keybuf = keybuf + String.fromCharCode(e.keyCode);
        }
        
      });

      function start_transaction(type)
      {
        console.log("start transaction: " + type);
      }

      function end_transaction()
      {
        console.log("end transaction");
      }

      function add_item_to_transaction(item)
      {
        console.log("item added: " + item);
      }
      function checkout(user, item, callback) {
        firebase.child('users').child(user).once('value', function(snapshot) {
          var content = snapshot.val() || {
            items: []
          };

          content.items.push(item);
          firebase.child('users').child(user).update(content, callback);
        });
      }

      function checkin(user, item, callback) {
        firebase.child('users').child(user).once('value', function(snapshot) {
          var content = snapshot.val() || {
            items: []
          };

          for (var i = 0; i < content.items.length; i++) {
            if (content.items[i].toLowerCase() == item.toLowerCase()) {
              content.items.splice(i, 1);
              break;
            }
          }

          firebase.child('users').child(user).update(content, callback);
        });
      }

      function get_input() {
        var badge = $('#scanned_badge').val();
        var item = $('#scanned_item').val();

        if (badge && item) {
          return { badge: badge, item: item };
        }
      }

      function reset_input() {
        $('#scanned_item').val('');
      }

      function checkin_click() {
        var input = get_input();

        if (input) {
          checkin(input.badge, input.item);
          reset_input();
        }
        else {
          alert('Please scan a badge and an item');
        }
      }

      function checkout_click() {
        var input = get_input();

        if (input) {
          checkout(input.badge, input.item);
          reset_input();
        }
        else {
          alert('Please scan a badge and an item');
        }
      }

      function flatten(content) {
        var items = [];

        if (content) {
          for (var user in content.users) {
            items.push({
              user: user,
              items: content.users[user].items || []
            });
          }
        }

        return items;
      }

      function view(snapshot) {
        $('#items_checked_out').html(
          flatten(snapshot.val())
          .map(function(item) {
            return '<tr>'
              + '<td>' + item.user + '</td>'
              + '<td>' + item.items.join(', ') + '</td>'
              + '</tr>';
          })
          .join(''));
      }
    </script>
  </head>
  <body>

    <h3>&nbsp; Inventory Management</h3>
    <form>
      <div class="row collapse">
        <div class="small-3 large-2 columns">
          <span class="prefix">Badge</span>
        </div>
        <div class="small-9 large-10 columns">
          <input type="text" id="scanned_badge" placeholder="Scan badge...">
        </div>
      </div>
      <div class="row collapse">
        <div class="small-3 large-2 columns">
          <span class="prefix">Item</span>
        </div>
        <div class="small-9 large-10 columns">
          <input type="text" id="scanned_item" placeholder="Scan item...">
        </div>
      </div>
      <div class="row collapse">
        <div class="small-4 large-4 columns">
          <a href="javascript:checkout_click()" class="button expand">Check Out</a>
        </div>
        <div class="small-4 large-4 columns">
          <div></div>
        </div>
        <div class="small-4 large-4 columns">
          <a href="javascript:checkin_click()" class="button expand success">Check In</a>
        </div>
      </div>
    </form>

    <h3>&nbsp; Items Checked Out</h3>
    <table>
      <thead>
        <tr>
          <th width="200">Badge</th>
          <th>Items</th>
        </tr>
      </thead>
      <tbody id="items_checked_out">
      </tbody>
    </table>
    
   
    <script>
      $(document).foundation();

      $(document).ready(function() {
        firebase.on('value', view);
      });
    </script>
  </body>
</html>
